<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çœŸå¿ƒè¯å¤§å†’é™© - åœ†å½¢ç«æŠ€åœº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
            touch-action: manipulation;
        }

        /* 3D Dice Styles - Fixed for accurate rotation */
        .dice-container {
            perspective: 1000px;
            width: 100px;
            height: 100px;
            cursor: pointer;
        }

        @media (min-width: 768px) {
            .dice-container {
                width: 120px;
                height: 120px;
            }
        }

        .dice-container:hover {
            filter: brightness(1.1);
        }

        .dice-container.rolling {
            pointer-events: none;
            cursor: not-allowed;
        }

        .dice {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .dice-face {
            position: absolute;
            width: 100px;
            height: 100px;
            background: linear-gradient(145deg, #ffffff 0%, #e6e6e6 100%);
            border: 3px solid #ccc;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: #333;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1), 0 0 20px rgba(0,0,0,0.2);
            backface-visibility: hidden;
        }

        @media (min-width: 768px) {
            .dice-face {
                width: 120px;
                height: 120px;
                font-size: 48px;
                border-radius: 20px;
            }
        }

        /* Fixed rotation mappings - standard dice layout */
        .dice-face:nth-child(1) { transform: rotateY(0deg) translateZ(50px); }
        .dice-face:nth-child(2) { transform: rotateY(90deg) translateZ(50px); }
        .dice-face:nth-child(3) { transform: rotateY(180deg) translateZ(50px); }
        .dice-face:nth-child(4) { transform: rotateY(-90deg) translateZ(50px); }
        .dice-face:nth-child(5) { transform: rotateX(90deg) translateZ(50px); }
        .dice-face:nth-child(6) { transform: rotateX(-90deg) translateZ(50px); }

        @media (min-width: 768px) {
            .dice-face:nth-child(1) { transform: rotateY(0deg) translateZ(60px); }
            .dice-face:nth-child(2) { transform: rotateY(90deg) translateZ(60px); }
            .dice-face:nth-child(3) { transform: rotateY(180deg) translateZ(60px); }
            .dice-face:nth-child(4) { transform: rotateY(-90deg) translateZ(60px); }
            .dice-face:nth-child(5) { transform: rotateX(90deg) translateZ(60px); }
            .dice-face:nth-child(6) { transform: rotateX(-90deg) translateZ(60px); }
        }

        /* Dice dots */
        .dot {
            width: 16px;
            height: 16px;
            background: #333;
            border-radius: 50%;
            position: absolute;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
        }

        @media (min-width: 768px) {
            .dot {
                width: 20px;
                height: 20px;
            }
        }

        .face-1 .dot:nth-child(1) { top: 50%; left: 50%; transform: translate(-50%, -50%); width: 24px; height: 24px; background: #e74c3c; }
        @media (min-width: 768px) {
            .face-1 .dot:nth-child(1) { width: 30px; height: 30px; }
        }
        .face-2 .dot:nth-child(1) { top: 25%; left: 25%; }
        .face-2 .dot:nth-child(2) { bottom: 25%; right: 25%; }
        .face-3 .dot:nth-child(1) { top: 25%; left: 25%; }
        .face-3 .dot:nth-child(2) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .face-3 .dot:nth-child(3) { bottom: 25%; right: 25%; }
        .face-4 .dot:nth-child(1) { top: 25%; left: 25%; }
        .face-4 .dot:nth-child(2) { top: 25%; right: 25%; }
        .face-4 .dot:nth-child(3) { bottom: 25%; left: 25%; }
        .face-4 .dot:nth-child(4) { bottom: 25%; right: 25%; }
        .face-5 .dot:nth-child(1) { top: 25%; left: 25%; }
        .face-5 .dot:nth-child(2) { top: 25%; right: 25%; }
        .face-5 .dot:nth-child(3) { top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .face-5 .dot:nth-child(4) { bottom: 25%; left: 25%; }
        .face-5 .dot:nth-child(5) { bottom: 25%; right: 25%; }
        .face-6 .dot:nth-child(1) { top: 25%; left: 25%; }
        .face-6 .dot:nth-child(2) { top: 25%; right: 25%; }
        .face-6 .dot:nth-child(3) { top: 50%; left: 25%; }
        .face-6 .dot:nth-child(4) { top: 50%; right: 25%; }
        .face-6 .dot:nth-child(5) { bottom: 25%; left: 25%; }
        .face-6 .dot:nth-child(6) { bottom: 25%; right: 25%; }

        /* Sector Styles */
        .sector {
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .sector:hover {
            filter: brightness(1.2);
        }

        .sector.selected {
            filter: brightness(1.3) drop-shadow(0 0 30px currentColor);
            z-index: 10;
        }

        .sector.selected::before {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 70%);
            animation: pulse 1.5s infinite;
            z-index: -1;
        }

        .sector.rolled {
            filter: grayscale(0.3);
            cursor: not-allowed;
        }

        .sector.rolled:hover {
            filter: grayscale(0.3);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 0.4; }
        }

        /* Card Styles */
        .card {
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            backface-visibility: hidden;
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .card-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: rotateY(0deg);
        }

        .card-front {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transform: rotateY(180deg);
            font-size: 14px;
            line-height: 1.6;
        }

        .card.enlarged {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotateY(180deg) scale(1.5);
            z-index: 1000;
            width: 320px;
            height: 220px;
        }

        @media (min-width: 768px) {
            .card.enlarged {
                transform: translate(-50%, -50%) rotateY(180deg) scale(2);
                width: 400px;
                height: 280px;
            }
        }

        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255,255,255,0.5); }
            50% { box-shadow: 0 0 40px rgba(255,255,255,0.8), 0 0 60px rgba(255,255,255,0.4); }
        }

        .glow-text {
            animation: glow 2s ease-in-out infinite;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            animation: particle-float 3s ease-out forwards;
        }

        @keyframes particle-float {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        .status-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            background: rgba(0,0,0,0.5);
            color: white;
        }

        @media (min-width: 768px) {
            .status-badge {
                top: 10px;
                right: 10px;
                padding: 4px 12px;
                font-size: 12px;
            }
        }

        /* Debug info display */
        .debug-info {
            position: absolute;
            bottom: 80px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 8px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 10px;
            color: #00ff00;
            z-index: 100;
            max-width: 150px;
        }

        @media (min-width: 768px) {
            .debug-info {
                bottom: 20px;
                right: 20px;
                padding: 10px;
                font-size: 12px;
                max-width: none;
            }
        }

        /* Dice hint text */
        .dice-hint {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            font-weight: bold;
            color: rgba(255,255,255,0.7);
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        @media (min-width: 768px) {
            .dice-hint {
                bottom: -40px;
                font-size: 14px;
            }
        }

        .dice-hint.hidden {
            display: none;
        }

        /* Music button animation */
        @keyframes musicPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .music-playing {
            animation: musicPulse 2s infinite;
            background: rgba(16, 185, 129, 0.3) !important;
            border-color: rgba(16, 185, 129, 0.5) !important;
        }

        /* Mobile-specific styles */
        .mobile-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1);
            transform: translateY(calc(100% - 60px));
            transition: transform 0.3s ease;
            z-index: 40;
            max-height: 50vh;
        }

        .mobile-panel.expanded {
            transform: translateY(0);
        }

        .mobile-panel-handle {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .mobile-panel-content {
            padding: 0 16px 16px;
            overflow-y: auto;
            max-height: calc(50vh - 60px);
        }

        .game-board-container {
            width: 100vw;
            height: 100vw;
            max-width: min(90vw, 600px);
            max-height: min(90vw, 600px);
            position: relative;
        }

        @media (min-width: 768px) {
            .game-board-container {
                width: 800px;
                height: 800px;
                max-width: 800px;
                max-height: 800px;
            }
        }

        /* Floating action buttons for mobile */
        .fab-container {
            position: fixed;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 30;
        }

        @media (min-width: 768px) {
            .fab-container {
                display: none;
            }
        }

        .fab {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .fab:hover, .fab:active {
            background: rgba(255,255,255,0.25);
            transform: scale(1.1);
        }

        .fab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: bold;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Desktop panels */
        .desktop-panel {
            display: none;
        }

        @media (min-width: 768px) {
            .desktop-panel {
                display: block;
            }
            .mobile-panel {
                display: none;
            }
        }

        /* Compact score display for mobile */
        .compact-score {
            position: fixed;
            top: 70px;
            left: 10px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 30;
            border: 1px solid rgba(255,255,255,0.1);
        }

        @media (min-width: 768px) {
            .compact-score {
                display: none;
            }
        }

        /* Ensure text is readable on small screens */
        @media (max-width: 767px) {
            .sector text {
                font-size: 16px !important;
            }
            .sector text[id^="score-"] {
                font-size: 24px !important;
            }
        }

        /* Roll Result Modal Styles */
        .roll-result-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .roll-result-modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .roll-result-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 24px;
            padding: 40px 60px;
            text-align: center;
            transform: scale(0.8);
            transition: transform 0.3s ease;
            max-width: 90vw;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .roll-result-modal.show .roll-result-content {
            transform: scale(1);
        }

        @media (max-width: 767px) {
            .roll-result-content {
                padding: 30px 40px;
            }
        }

        .roll-result-player {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
            color: white;
        }

        @media (max-width: 767px) {
            .roll-result-player {
                font-size: 22px;
            }
        }

        .roll-result-text {
            font-size: 20px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 30px;
        }

        .roll-result-number {
            font-size: 120px;
            font-weight: 900;
            line-height: 1;
            margin: 20px 0;
            text-shadow: 0 0 40px currentColor;
            animation: numberPop 0.5s ease;
        }

        @media (max-width: 767px) {
            .roll-result-number {
                font-size: 80px;
            }
        }

        @keyframes numberPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        .roll-result-btn {
            margin-top: 30px;
            padding: 16px 48px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
        }

        .roll-result-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 30px rgba(16, 185, 129, 0.6);
        }

        .dice-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            position: relative;
        }

        @media (max-width: 767px) {
            .dice-icon {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center text-white">
    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="bgMusic" loop>
        <source src="å†’é™©å²›-å†’é™©å²› æƒ³å¿µä½ .mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
    </audio>
    
    <!-- éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <button id="musicToggle" onclick="toggleMusic()" class="absolute top-4 right-4 z-50 px-3 py-2 glass rounded-full font-bold hover:bg-white/20 transition-colors flex items-center gap-2 text-sm md:text-base md:px-4 md:py-2">
        <span id="musicIcon">ğŸ”‡</span>
        <span id="musicText" class="hidden md:inline">æ’­æ”¾éŸ³ä¹</span>
    </button>

    <!-- Setup Screen -->
    <div id="setupScreen" class="absolute inset-0 flex flex-col items-center justify-center z-50 bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 overflow-y-auto p-4">
        <div class="glass rounded-3xl p-6 md:p-8 max-w-2xl w-full shadow-2xl my-auto">
            <h1 class="text-3xl md:text-5xl font-black text-center mb-6 md:mb-8 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 bg-clip-text text-transparent">
                çœŸå¿ƒè¯å¤§å†’é™©
            </h1>
            <p class="text-center text-gray-300 mb-6 md:mb-8 text-base md:text-lg">è®¾ç½®æ¸¸æˆè§’è‰²</p>
            
            <div class="space-y-3 md:space-y-4 mb-6 md:mb-8" id="playerInputs">
                <!-- Dynamic player inputs will be inserted here -->
            </div>

            <div class="flex gap-3 md:gap-4 justify-center">
                <button onclick="addPlayer()" class="px-4 py-2 md:px-6 md:py-3 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full font-bold hover:scale-105 transition-transform shadow-lg text-sm md:text-base">
                    + æ·»åŠ è§’è‰²
                </button>
                <button onclick="removePlayer()" class="px-4 py-2 md:px-6 md:py-3 bg-gradient-to-r from-red-500 to-rose-600 rounded-full font-bold hover:scale-105 transition-transform shadow-lg text-sm md:text-base">
                    - ç§»é™¤è§’è‰²
                </button>
            </div>

            <button onclick="startGame()" class="w-full mt-6 md:mt-8 py-3 md:py-4 bg-gradient-to-r from-pink-600 via-purple-600 to-indigo-600 rounded-2xl font-black text-lg md:text-xl hover:scale-105 transition-transform shadow-2xl glow-text">
                å¼€å§‹æ¸¸æˆ
            </button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden absolute inset-0 flex items-center justify-center overflow-hidden">
        <!-- Game Board -->
        <div class="game-board-container">
            <svg id="gameBoard" class="w-full h-full" viewBox="0 0 800 800">
                <!-- Sectors will be drawn here -->
            </svg>

            <!-- Center Dice -->
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20">
                <div id="diceContainer" class="dice-container floating" onclick="rollDice()">
                    <div id="dice" class="dice">
                        <div class="dice-face face-1"><div class="dot"></div></div>
                        <div class="dice-face face-2"><div class="dot"></div><div class="dot"></div></div>
                        <div class="dice-face face-3"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="dice-face face-4"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="dice-face face-5"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <div class="dice-face face-6"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                </div>
                
                <!-- Dice hint text -->
                <div id="diceHint" class="dice-hint">å…ˆé€‰æ‹©è§’è‰²ï¼Œç„¶åç‚¹å‡»éª°å­</div>
                
                <!-- Debug display -->
                <div id="diceDebug" class="debug-info hidden">
                    <div>å†…éƒ¨ç‚¹æ•°: <span id="debugInternal">-</span></div>
                    <div>æ˜¾ç¤ºé¢: <span id="debugVisible">-</span></div>
                    <div>æ—‹è½¬: <span id="debugRotation">-</span></div>
                </div>
            </div>
        </div>

        <!-- Mobile: Compact round status -->
        <div class="compact-score">
            <span id="compactRound">ç¬¬1è½®</span> | <span id="compactRemaining">å‰©ä½™: 0</span>
        </div>

        <!-- Mobile: Floating Action Buttons -->
        <div class="fab-container">
            <div class="fab" onclick="toggleMobilePanel('scores')" style="position: relative;">
                ğŸ“Š
                <span id="scoreBadge" class="fab-badge hidden">!</span>
            </div>
            <div class="fab" onclick="toggleMobilePanel('logs')" style="position: relative;">
                ğŸ“œ
                <span id="logBadge" class="fab-badge hidden">1</span>
            </div>
            <div class="fab" onclick="resetGame()">ğŸ”„</div>
        </div>

        <!-- Mobile: Bottom Panel -->
        <div id="mobilePanel" class="mobile-panel">
            <div class="mobile-panel-handle" onclick="toggleMobilePanel()">
                <div class="w-12 h-1 bg-white/30 rounded-full"></div>
            </div>
            <div class="mobile-panel-content">
                <!-- Scores View -->
                <div id="mobileScoresView" class="hidden">
                    <h3 class="text-lg font-bold mb-3 text-cyan-400">å½“å‰ç‚¹æ•°</h3>
                    <div id="mobileScoreBoard" class="space-y-2"></div>
                    <div id="mobileRoundStatus" class="mt-4 pt-3 border-t border-white/20 text-sm text-gray-300">
                        ç­‰å¾…æŠ•æ·...
                    </div>
                </div>
                <!-- Logs View -->
                <div id="mobileLogsView" class="hidden">
                    <h3 class="text-lg font-bold mb-3 text-pink-400">æ¸¸æˆè®°å½•</h3>
                    <div id="mobileGameLog" class="text-sm space-y-2 text-gray-300 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Desktop: Score Panel -->
        <div class="desktop-panel absolute top-4 right-4 glass rounded-2xl p-6 max-w-xs w-64">
            <h3 class="text-xl font-bold mb-4 text-cyan-400">å½“å‰ç‚¹æ•°</h3>
            <div id="scoreBoard" class="space-y-3">
                <!-- Scores will be displayed here -->
            </div>
            <div id="roundStatus" class="mt-4 pt-4 border-t border-white/20 text-sm text-gray-300">
                ç­‰å¾…æŠ•æ·...
            </div>
        </div>

        <!-- Desktop: Game Log -->
        <div class="desktop-panel absolute bottom-4 left-4 glass rounded-2xl p-4 max-w-md max-h-48 overflow-y-auto">
            <h3 class="text-lg font-bold mb-2 text-pink-400">æ¸¸æˆè®°å½•</h3>
            <div id="gameLog" class="text-sm space-y-1 text-gray-300"></div>
        </div>

        <!-- Desktop: Reset Button -->
        <button onclick="resetGame()" class="desktop-panel absolute top-4 left-4 px-6 py-3 glass rounded-full font-bold hover:bg-white/20 transition-colors">
            é‡ç½®æ¸¸æˆ
        </button>
        
        <!-- Desktop: Toggle Debug -->
        <button onclick="toggleDebug()" class="desktop-panel absolute bottom-4 right-4 px-4 py-2 glass rounded-full text-xs font-bold hover:bg-white/20 transition-colors">
            è°ƒè¯•ä¿¡æ¯
        </button>
    </div>

    <!-- Roll Result Modal -->
    <div id="rollResultModal" class="roll-result-modal">
        <div class="roll-result-content">
            <div class="dice-icon">
                <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="10" y="10" width="80" height="80" rx="15" fill="white" stroke="#ccc" stroke-width="3"/>
                    <circle id="resultDot1" cx="50" cy="50" r="12" fill="#333" style="display:none"/>
                    <circle id="resultDot2" cx="30" cy="30" r="8" fill="#333" style="display:none"/>
                    <circle id="resultDot3" cx="70" cy="70" r="8" fill="#333" style="display:none"/>
                    <circle id="resultDot4" cx="30" cy="70" r="8" fill="#333" style="display:none"/>
                    <circle id="resultDot5" cx="70" cy="30" r="8" fill="#333" style="display:none"/>
                    <circle id="resultDot6" cx="30" cy="50" r="8" fill="#333" style="display:none"/>
                    <circle id="resultDot7" cx="70" cy="50" r="8" fill="#333" style="display:none"/>
                </svg>
            </div>
            <div class="roll-result-player" id="resultPlayerName">ç©å®¶åç§°</div>
            <div class="roll-result-text">æŠ•æ·å‡ºäº†</div>
            <div class="roll-result-number" id="resultNumber">6</div>
            <div class="roll-result-text">ç‚¹ï¼</div>
            <button class="roll-result-btn" onclick="closeRollResult()">ç¡®å®š</button>
        </div>
    </div>

    <!-- Round Summary Modal -->
    <div id="summaryModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="glass rounded-3xl p-6 md:p-8 max-w-2xl w-full mx-4 transform scale-100 transition-transform max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl md:text-3xl font-black text-center mb-6 text-white">æœ¬è½®ç»“æœ</h2>
            
            <div id="summaryContent" class="space-y-3 md:space-y-4 mb-6 md:mb-8">
                <!-- Dynamic content -->
            </div>

            <div class="bg-white/10 rounded-xl p-4 md:p-6 mb-6 md:mb-8">
                <h3 class="text-lg md:text-xl font-bold mb-3 md:mb-4 text-yellow-400">åœºä¸Šæƒ…å†µ</h3>
                <div id="situationDetails" class="space-y-2 text-base md:text-lg">
                    <!-- Situation details -->
                </div>
            </div>

            <div class="flex gap-3 md:gap-4 justify-center">
                <button onclick="confirmPunishment()" class="flex-1 px-4 py-3 md:px-8 md:py-4 bg-gradient-to-r from-red-500 to-pink-600 rounded-2xl font-black text-lg md:text-xl hover:scale-105 transition-transform shadow-2xl">
                    ç¡®è®¤æƒ©ç½š
                </button>
                <button onclick="restartRound()" class="flex-1 px-4 py-3 md:px-8 md:py-4 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-2xl font-black text-lg md:text-xl hover:scale-105 transition-transform shadow-2xl hidden" id="restartBtn">
                    é‡æ–°å¼€å§‹
                </button>
            </div>
        </div>
    </div>

    <!-- Choice Modal (Truth or Dare) -->
    <div id="choiceModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4">
        <div class="glass rounded-3xl p-6 md:p-8 max-w-4xl w-full">
            <h2 id="punishmentTitle" class="text-2xl md:text-3xl font-black text-center mb-6 md:mb-8 text-red-400"></h2>
            <div class="flex flex-col md:flex-row gap-4 md:gap-8 justify-center items-center">
                <div onclick="selectPunishmentType('truth')" class="cursor-pointer transform hover:scale-105 transition-all w-full md:w-auto">
                    <div class="w-full md:w-64 h-48 md:h-96 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-2xl flex flex-col items-center justify-center shadow-2xl border-4 border-white/30 hover:border-white/60">
                        <div class="text-4xl md:text-6xl mb-2 md:mb-4">ğŸ’­</div>
                        <h3 class="text-xl md:text-2xl font-black">çœŸå¿ƒè¯</h3>
                        <p class="text-xs md:text-sm mt-2 text-center px-4 text-blue-100">è¯šå®å›ç­”ä¸€ä¸ªé—®é¢˜</p>
                    </div>
                </div>
                <div onclick="selectPunishmentType('dare')" class="cursor-pointer transform hover:scale-105 transition-all w-full md:w-auto">
                    <div class="w-full md:w-64 h-48 md:h-96 bg-gradient-to-br from-red-500 to-pink-600 rounded-2xl flex flex-col items-center justify-center shadow-2xl border-4 border-white/30 hover:border-white/60">
                        <div class="text-4xl md:text-6xl mb-2 md:mb-4">ğŸ”¥</div>
                        <h3 class="text-xl md:text-2xl font-black">å¤§å†’é™©</h3>
                        <p class="text-xs md:text-sm mt-2 text-center px-4 text-red-100">å®Œæˆä¸€ä¸ªæŒ‘æˆ˜</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards Selection Modal -->
    <div id="cardsModal" class="hidden fixed inset-0 modal-overlay z-50 flex items-center justify-center overflow-y-auto py-4 md:py-10 p-4">
        <div class="glass rounded-3xl p-4 md:p-8 max-w-6xl w-full max-h-[95vh] overflow-y-auto">
            <h2 id="cardsTitle" class="text-2xl md:text-3xl font-black text-center mb-4 text-white"></h2>
            <p class="text-center text-gray-300 mb-6 md:mb-8 text-sm md:text-base">é€‰æ‹©ä¸€å¼ å¡ç‰Œï¼ˆé€‰ä¸­åæœ¬åœºæ¸¸æˆä¸å†å‡ºç°ï¼‰</p>
            <div id="cardsContainer" class="grid grid-cols-2 md:grid-cols-5 gap-3 md:gap-4 justify-items-center">
                <!-- 20 cards will be generated here -->
            </div>
            <button onclick="closeCardsModal()" class="mt-6 md:mt-8 w-full py-3 bg-gray-600 rounded-xl font-bold hover:bg-gray-500 transition-colors">
                å–æ¶ˆ
            </button>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="hidden fixed inset-0 modal-overlay z-[60] flex items-center justify-center p-4">
        <div id="resultCard" class="card w-72 h-48 md:w-96 md:h-64 relative cursor-pointer" onclick="this.classList.toggle('enlarged')">
            <div class="card-back flex flex-col items-center justify-center border-4 border-white/30">
                <div class="text-5xl md:text-6xl mb-2">ğŸ´</div>
                <p class="text-lg md:text-xl font-bold">ç‚¹å‡»ç¿»è½¬</p>
            </div>
            <div id="resultContent" class="card-front flex flex-col items-center justify-center border-4 border-white/30 p-4 md:p-6 text-gray-800 font-bold text-base md:text-lg">
                <!-- Content will be inserted here -->
            </div>
        </div>
        <button onclick="nextRound()" class="absolute bottom-10 md:bottom-20 px-6 py-3 md:px-8 md:py-4 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full font-black text-lg md:text-xl hover:scale-105 transition-transform shadow-2xl">
            ä¸‹ä¸€è½®
        </button>
    </div>

    <script>
        // Game Data
        let players = [];
        let currentRound = 0;
        let selectedPlayer = null;
        let currentScores = {};
        let usedTruthCards = new Set();
        let usedDareCards = new Set();
        let isRolling = false;
        let currentPunishmentType = '';
        let losers = [];
        let isTiebreak = false;
        let hasRolled = new Set();
        let debugMode = false;
        let lastDiceResult = null;
        let currentMobilePanel = null;
        let pendingResult = null; // å­˜å‚¨ç­‰å¾…æ˜¾ç¤ºçš„ç»“æœ

        // Card Libraries
        const truthCards = [
            "ä½ åšè¿‡æœ€å°´å°¬çš„äº‹æƒ…æ˜¯ä»€ä¹ˆï¼Ÿ",
            "ä½ æš—æ‹è¿‡åœ¨åœºçš„è°å—ï¼Ÿ",
            "ä½ æ’’è¿‡æœ€å¤§çš„è°æ˜¯ä»€ä¹ˆï¼Ÿ",
            "ä½ æœ€å®³æ€•å¤±å»ä»€ä¹ˆï¼Ÿ",
            "ä½ åšè¿‡æœ€åæ‚”çš„å†³å®šæ˜¯ä»€ä¹ˆï¼Ÿ",
            "ä½ çš„åˆå»æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ",
            "ä½ å·å·çœ‹è¿‡åˆ«äººçš„æ‰‹æœºå—ï¼Ÿ",
            "ä½ å“­è¿‡æœ€ä¼¤å¿ƒçš„ä¸€æ¬¡æ˜¯å› ä¸ºä»€ä¹ˆï¼Ÿ",
            "ä½ æœ€è®¨åŒè‡ªå·±çš„å“ªä¸ªç¼ºç‚¹ï¼Ÿ",
            "ä½ åšè¿‡æœ€ç–¯ç‹‚çš„äº‹æƒ…æ˜¯ä»€ä¹ˆï¼Ÿ",
            "ä½ å¯¹å‰ä»»è¿˜æœ‰ä»€ä¹ˆæƒ³è¯´çš„ï¼Ÿ",
            "ä½ æœ‰è¿‡æš—æ‹è€å¸ˆ/ä¸Šå¸çš„ç»å†å—ï¼Ÿ",
            "ä½ è§‰å¾—è‡ªå·±æœ€å¤§çš„ç§˜å¯†æ˜¯ä»€ä¹ˆï¼Ÿ",
            "ä½ åšè¿‡æœ€å¯¹ä¸èµ·åˆ«äººçš„äº‹æ˜¯ä»€ä¹ˆï¼Ÿ",
            "ä½ æœ€æƒ³åˆ é™¤çš„ä¸€æ®µè®°å¿†æ˜¯ä»€ä¹ˆï¼Ÿ",
            "ä½ æ›¾ç»åœ¨èƒŒåè¯´è¿‡è°çš„åè¯ï¼Ÿ",
            "ä½ è§‰å¾—è‡ªå·±æœ€å¸å¼•äººçš„åœ°æ–¹æ˜¯ä»€ä¹ˆï¼Ÿ",
            "ä½ åšè¿‡æœ€ä¸¢è„¸çš„æ¢¦æ˜¯ä»€ä¹ˆï¼Ÿ",
            "ä½ æœ€ç¾¡æ…•åˆ«äººä»€ä¹ˆï¼Ÿ",
            "ä½ è§‰å¾—è‡ªå·±æ˜¯ä¸ªå¥½äººå—ï¼Ÿ"
        ];

        const dareCards = [
            "æ¨¡ä»¿ä¸€ç§åŠ¨ç‰©å«å£°æŒç»­30ç§’",
            "ç»™é€šè®¯å½•ç¬¬3ä¸ªäººå‘'æˆ‘æƒ³ä½ äº†'",
            "åš10ä¸ªä¿¯å§æ’‘",
            "å­¦é¸­å­èµ°è·¯ç»•åœºä¸€å‘¨",
            "ç”¨å±è‚¡å†™è‡ªå·±çš„åå­—",
            "ç»™å‰ä»»æ‰“ç”µè¯è¯´'æˆ‘å¾ˆå¥½'",
            "å–ä¸‹ä¸€å¤§æ¯æ°´",
            "åšé¬¼è„¸ä¿æŒ30ç§’",
            "è·³ä¸€æ®µå¹¿åœºèˆ",
            "ç”¨æ–¹è¨€å¿µä¸€æ®µå°è¯",
            "é—­çœ¼è½¬10åœˆåèµ°ç›´çº¿",
            "ç»™å–œæ¬¢çš„äººè¡¨ç™½ï¼ˆå‡è£…ï¼‰",
            "åƒä¸€å£æŸ æª¬",
            "åš20ä¸ªæ·±è¹²",
            "å­¦æœºå™¨äººè·³èˆ",
            "ç”¨å”±æ­Œçš„è°ƒå­è¯´è¯ç›´åˆ°ä¸‹è½®",
            "ç»™å¥½å‹å‘è¯­éŸ³å”±ä¸€é¦–æ­Œ",
            "å•è„šç«™ç«‹1åˆ†é’Ÿ",
            "åš5ä¸ªè›™è·³",
            "æ¨¡ä»¿ä¸€ä½æ˜æ˜Ÿçš„ç»å…¸åŠ¨ä½œ"
        ];

        let playerCount = 2;
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2'];

        // Precise dice rotation mappings
        const diceRotations = {
            1: { x: 0, y: 0, desc: "æ­£é¢ (1ç‚¹æœä¸Š)" },
            2: { x: 0, y: -90, desc: "å³é¢ (2ç‚¹æœä¸Š)" },
            3: { x: 0, y: 180, desc: "èƒŒé¢ (3ç‚¹æœä¸Š)" },
            4: { x: 0, y: 90, desc: "å·¦é¢ (4ç‚¹æœä¸Š)" },
            5: { x: -90, y: 0, desc: "é¡¶é¢ (5ç‚¹æœä¸Š)" },
            6: { x: 90, y: 0, desc: "åº•é¢ (6ç‚¹æœä¸Š)" }
        };

        // Music control
        let isMusicPlaying = false;
        const bgMusic = document.getElementById('bgMusic');

        function toggleMusic() {
            const musicIcon = document.getElementById('musicIcon');
            const musicText = document.getElementById('musicText');
            const musicBtn = document.getElementById('musicToggle');
            
            if (isMusicPlaying) {
                bgMusic.pause();
                musicIcon.textContent = 'ğŸ”‡';
                musicText.textContent = 'æ’­æ”¾éŸ³ä¹';
                musicBtn.classList.remove('music-playing');
                isMusicPlaying = false;
                addLog('èƒŒæ™¯éŸ³ä¹å·²æš‚åœ');
            } else {
                bgMusic.play().catch(e => {
                    console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                    alert('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶"å†’é™©å²›-å†’é™©å²› æƒ³å¿µä½ .mp3"æ˜¯å¦å­˜åœ¨äºåŒä¸€ç›®å½•');
                });
                musicIcon.textContent = 'ğŸ”Š';
                musicText.textContent = 'æš‚åœéŸ³ä¹';
                musicBtn.classList.add('music-playing');
                isMusicPlaying = true;
                addLog('èƒŒæ™¯éŸ³ä¹å·²æ’­æ”¾');
            }
        }

        function initSetup() {
            updatePlayerInputs();
        }

        function updatePlayerInputs() {
            const container = document.getElementById('playerInputs');
            container.innerHTML = '';
            
            for (let i = 0; i < playerCount; i++) {
                const div = document.createElement('div');
                div.className = 'flex gap-2 md:gap-4 items-center';
                div.innerHTML = `
                    <input type="text" id="playerName${i}" placeholder="è§’è‰²${i+1}åç§°" 
                        class="flex-1 px-3 py-2 md:px-4 md:py-3 rounded-xl bg-white/10 border border-white/30 text-white placeholder-gray-400 focus:outline-none focus:border-cyan-400 text-sm md:text-base"
                        value="ç©å®¶${i+1}">
                    <input type="color" id="playerColor${i}" value="${colors[i % colors.length]}" 
                        class="w-12 h-10 md:w-16 md:h-12 rounded-lg cursor-pointer border-2 border-white/30">
                `;
                container.appendChild(div);
            }
        }

        function addPlayer() {
            if (playerCount < 8) {
                playerCount++;
                updatePlayerInputs();
            }
        }

        function removePlayer() {
            if (playerCount > 2) {
                playerCount--;
                updatePlayerInputs();
            }
        }

        function startGame() {
            players = [];
            hasRolled.clear();
            for (let i = 0; i < playerCount; i++) {
                const name = document.getElementById(`playerName${i}`).value || `ç©å®¶${i+1}`;
                const color = document.getElementById(`playerColor${i}`).value;
                players.push({ id: i, name, color, score: 0 });
            }
            
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            drawBoard();
            updateScoreBoard();
            updateMobileScoreBoard();
            addLog('æ¸¸æˆå¼€å§‹ï¼è¯·é€‰æ‹©è§’è‰²å¹¶ç‚¹å‡»éª°å­æŠ•æ·');
            updateRoundStatus();
            updateDiceHint();
        }

        function drawBoard() {
            const svg = document.getElementById('gameBoard');
            svg.innerHTML = '';
            
            const centerX = 400;
            const centerY = 400;
            const radius = 350;
            const innerRadius = 100;
            const anglePerSector = 360 / players.length;
            
            players.forEach((player, index) => {
                const startAngle = index * anglePerSector - 90;
                const endAngle = (index + 1) * anglePerSector - 90;
                
                const path = createSectorPath(centerX, centerY, innerRadius, radius, startAngle, endAngle);
                
                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('class', 'sector');
                group.setAttribute('data-player', index);
                group.onclick = () => selectPlayer(index);
                
                const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                pathElement.setAttribute('d', path);
                pathElement.setAttribute('fill', player.color);
                pathElement.setAttribute('stroke', 'rgba(255,255,255,0.3)');
                pathElement.setAttribute('stroke-width', '2');
                pathElement.setAttribute('id', `sector-${index}`);
                
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
                gradient.setAttribute('id', `grad-${index}`);
                gradient.innerHTML = `
                    <stop offset="0%" stop-color="${player.color}" stop-opacity="0.8"/>
                    <stop offset="100%" stop-color="${player.color}" stop-opacity="1"/>
                `;
                defs.appendChild(gradient);
                svg.appendChild(defs);
                
                pathElement.setAttribute('fill', `url(#grad-${index})`);
                
                const textAngle = startAngle + anglePerSector / 2;
                const textRadius = (radius + innerRadius) / 2;
                const textX = centerX + textRadius * Math.cos(textAngle * Math.PI / 180);
                const textY = centerY + textRadius * Math.sin(textAngle * Math.PI / 180);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', textX);
                text.setAttribute('y', textY);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dominant-baseline', 'middle');
                text.setAttribute('fill', 'white');
                text.setAttribute('font-size', window.innerWidth < 768 ? '20' : '24');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('pointer-events', 'none');
                text.textContent = player.name;
                
                const scoreText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                scoreText.setAttribute('id', `score-${index}`);
                scoreText.setAttribute('x', textX);
                scoreText.setAttribute('y', textY + (window.innerWidth < 768 ? '25' : '30'));
                scoreText.setAttribute('text-anchor', 'middle');
                scoreText.setAttribute('dominant-baseline', 'middle');
                scoreText.setAttribute('fill', 'rgba(255,255,255,0.9)');
                scoreText.setAttribute('font-size', window.innerWidth < 768 ? '28' : '36');
                scoreText.setAttribute('font-weight', '900');
                scoreText.setAttribute('pointer-events', 'none');
                scoreText.textContent = '-';
                
                const badge = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                badge.setAttribute('cx', centerX + (radius - 40) * Math.cos(textAngle * Math.PI / 180));
                badge.setAttribute('cy', centerY + (radius - 40) * Math.sin(textAngle * Math.PI / 180));
                badge.setAttribute('r', window.innerWidth < 768 ? '6' : '8');
                badge.setAttribute('fill', '#f59e0b');
                badge.setAttribute('id', `status-${index}`);
                badge.setAttribute('opacity', '0');
                
                group.appendChild(pathElement);
                group.appendChild(text);
                group.appendChild(scoreText);
                group.appendChild(badge);
                svg.appendChild(group);
            });
        }

        function createSectorPath(cx, cy, rInner, rOuter, startAngle, endAngle) {
            const start = polarToCartesian(cx, cy, rOuter, endAngle);
            const end = polarToCartesian(cx, cy, rOuter, startAngle);
            const innerStart = polarToCartesian(cx, cy, rInner, endAngle);
            const innerEnd = polarToCartesian(cx, cy, rInner, startAngle);
            
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
            
            return [
                "M", start.x, start.y,
                "A", rOuter, rOuter, 0, largeArcFlag, 0, end.x, end.y,
                "L", innerEnd.x, innerEnd.y,
                "A", rInner, rInner, 0, largeArcFlag, 1, innerStart.x, innerStart.y,
                "Z"
            ].join(" ");
        }

        function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = (angleInDegrees * Math.PI) / 180.0;
            return {
                x: centerX + (radius * Math.cos(angleInRadians)),
                y: centerY + (radius * Math.sin(angleInRadians))
            };
        }

        function selectPlayer(index) {
            if (hasRolled.has(index)) {
                addLog(`${players[index].name} å·²ç»æŠ•æ·è¿‡äº†ï¼`);
                return;
            }
            if (isRolling) return;
            
            document.querySelectorAll('.sector').forEach(sector => {
                sector.classList.remove('selected');
            });
            
            const sector = document.querySelector(`[data-player="${index}"]`);
            sector.classList.add('selected');
            
            selectedPlayer = index;
            addLog(`é€‰æ‹©äº† ${players[index].name}`);
            updateDiceHint();
        }

        function updateDiceHint() {
            const hint = document.getElementById('diceHint');
            if (selectedPlayer === null) {
                hint.textContent = 'å…ˆé€‰æ‹©è§’è‰²ï¼Œç„¶åç‚¹å‡»éª°å­';
                hint.classList.remove('hidden');
            } else if (hasRolled.has(selectedPlayer)) {
                hint.classList.add('hidden');
            } else {
                hint.textContent = `ç‚¹å‡»éª°å­æŠ•æ· (${players[selectedPlayer].name})`;
                hint.classList.remove('hidden');
            }
        }

        function rollDice() {
            if (selectedPlayer === null) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼');
                return;
            }
            if (hasRolled.has(selectedPlayer)) {
                alert('è¯¥è§’è‰²å·²ç»æŠ•æ·è¿‡äº†ï¼');
                return;
            }
            if (isRolling) return;
            
            isRolling = true;
            const diceContainer = document.getElementById('diceContainer');
            const dice = document.getElementById('dice');
            
            diceContainer.classList.add('rolling');
            
            const result = Math.floor(Math.random() * 6) + 1;
            lastDiceResult = result;
            
            const baseRotation = diceRotations[result];
            const spinsX = 2 + Math.floor(Math.random() * 2);
            const spinsY = 2 + Math.floor(Math.random() * 2);
            
            const finalX = baseRotation.x + (spinsX * 360);
            const finalY = baseRotation.y + (spinsY * 360);
            
            dice.style.transform = `rotateX(${finalX}deg) rotateY(${finalY}deg)`;
            
            if (debugMode) {
                document.getElementById('debugInternal').textContent = result;
                document.getElementById('debugVisible').textContent = baseRotation.desc;
                document.getElementById('debugRotation').textContent = `X:${finalX}Â° Y:${finalY}Â°`;
            }
            
            createParticles();
            
            setTimeout(() => {
                if (result !== lastDiceResult) {
                    console.error('Dice result mismatch!', result, lastDiceResult);
                }
                
                currentScores[selectedPlayer] = result;
                hasRolled.add(selectedPlayer);
                
                const sector = document.querySelector(`[data-player="${selectedPlayer}"]`);
                sector.classList.remove('selected');
                sector.classList.add('rolled');
                
                const badge = document.getElementById(`status-${selectedPlayer}`);
                badge.setAttribute('fill', '#10b981');
                badge.setAttribute('opacity', '1');
                
                document.getElementById(`score-${selectedPlayer}`).textContent = result;
                
                diceContainer.classList.remove('rolling');
                
                // æ˜¾ç¤ºç»“æœå¼¹çª—
                showRollResult(players[selectedPlayer].name, result, players[selectedPlayer].color);
                
            }, 1200);
        }

        function showRollResult(playerName, result, playerColor) {
            pendingResult = { playerName, result };
            
            // è®¾ç½®å¼¹çª—å†…å®¹
            document.getElementById('resultPlayerName').textContent = playerName;
            document.getElementById('resultPlayerName').style.color = playerColor;
            document.getElementById('resultNumber').textContent = result;
            document.getElementById('resultNumber').style.color = playerColor;
            
            // è®¾ç½®éª°å­å›¾æ ‡ç‚¹æ•°
            updateResultDiceIcon(result);
            
            // æ˜¾ç¤ºå¼¹çª—
            const modal = document.getElementById('rollResultModal');
            modal.classList.add('show');
            
            addLog(`${playerName} æ·å‡ºäº† ${result} ç‚¹`);
        }

        function updateResultDiceIcon(number) {
            // éšè—æ‰€æœ‰ç‚¹
            for (let i = 1; i <= 7; i++) {
                const dot = document.getElementById(`resultDot${i}`);
                if (dot) dot.style.display = 'none';
            }
            
            // æ ¹æ®ç‚¹æ•°æ˜¾ç¤ºå¯¹åº”çš„ç‚¹
            const dotPatterns = {
                1: [1],
                2: [2, 3],
                3: [1, 2, 3],
                4: [2, 3, 4, 5],
                5: [1, 2, 3, 4, 5],
                6: [2, 3, 4, 5, 6, 7]
            };
            
            const pattern = dotPatterns[number] || [];
            pattern.forEach(dotId => {
                const dot = document.getElementById(`resultDot${dotId}`);
                if (dot) dot.style.display = 'block';
            });
            
            // 1ç‚¹å’Œ4ç‚¹ç‰¹æ®Šé¢œè‰²
            const dot1 = document.getElementById('resultDot1');
            if (dot1) {
                dot1.setAttribute('fill', number === 1 ? '#e74c3c' : '#333');
            }
        }

        function closeRollResult() {
            const modal = document.getElementById('rollResultModal');
            modal.classList.remove('show');
            
            // ç»§ç»­æ¸¸æˆæµç¨‹
            updateScoreBoard();
            updateMobileScoreBoard();
            updateRoundStatus();
            updateDiceHint();
            
            checkRoundComplete();
        }

        function createParticles() {
            const container = document.querySelector('.dice-container');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.cssText = `
                    width: ${Math.random() * 10 + 5}px;
                    height: ${Math.random() * 10 + 5}px;
                    background: ${players[selectedPlayer].color};
                    border-radius: 50%;
                    left: 50%;
                    top: 50%;
                    --tx: ${(Math.random() - 0.5) * 200}px;
                    --ty: ${(Math.random() - 0.5) * 200}px;
                `;
                container.appendChild(particle);
                setTimeout(() => particle.remove(), 3000);
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const debugDiv = document.getElementById('diceDebug');
            debugDiv.classList.toggle('hidden', !debugMode);
        }

        function updateRoundStatus() {
            const statusDiv = document.getElementById('roundStatus');
            const compactRound = document.getElementById('compactRound');
            const compactRemaining = document.getElementById('compactRemaining');
            const remaining = players.length - hasRolled.size;
            
            if (isTiebreak) {
                const tieRemaining = losers.filter(id => !hasRolled.has(id)).length;
                const statusHTML = `
                    <div class="text-yellow-400 font-bold">âš”ï¸ å¯¹å†³æ¨¡å¼</div>
                    <div>å‰©ä½™æŠ•æ·: ${tieRemaining}/${losers.length}</div>
                `;
                if (statusDiv) statusDiv.innerHTML = statusHTML;
                if (compactRound) compactRound.textContent = 'å¯¹å†³';
                if (compactRemaining) compactRemaining.textContent = `å‰©ä½™: ${tieRemaining}`;
            } else {
                const statusHTML = `
                    <div class="text-cyan-400 font-bold">ğŸ² ç¬¬ ${currentRound + 1} è½®</div>
                    <div>å‰©ä½™æŠ•æ·: ${remaining}/${players.length}</div>
                `;
                if (statusDiv) statusDiv.innerHTML = statusHTML;
                if (compactRound) compactRound.textContent = `ç¬¬${currentRound + 1}è½®`;
                if (compactRemaining) compactRemaining.textContent = `å‰©ä½™: ${remaining}`;
            }
        }

        function checkRoundComplete() {
            const rolledCount = hasRolled.size;
            
            if (isTiebreak) {
                const losersRolled = losers.filter(id => hasRolled.has(id)).length;
                if (losersRolled === losers.length) {
                    setTimeout(showRoundSummary, 500);
                } else {
                    isRolling = false;
                    const nextLoser = losers.find(id => !hasRolled.has(id));
                    selectPlayer(nextLoser);
                }
            } else {
                if (rolledCount === players.length) {
                    setTimeout(showRoundSummary, 500);
                } else {
                    isRolling = false;
                    const nextPlayer = players.findIndex((_, i) => !hasRolled.has(i));
                    selectPlayer(nextPlayer);
                }
            }
        }

        function showRoundSummary() {
            const scores = Object.entries(currentScores).map(([id, score]) => ({ 
                id: parseInt(id), 
                score,
                name: players[parseInt(id)].name,
                color: players[parseInt(id)].color
            }));
            
            const minScore = Math.min(...scores.map(s => s.score));
            const minPlayers = scores.filter(s => s.score === minScore);
            
            const summaryContent = document.getElementById('summaryContent');
            const situationDetails = document.getElementById('situationDetails');
            const restartBtn = document.getElementById('restartBtn');
            
            summaryContent.innerHTML = '';
            situationDetails.innerHTML = '';
            
            scores.sort((a, b) => a.score - b.score);
            
            scores.forEach((s, index) => {
                const isLoser = s.score === minScore;
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-2 md:p-3 rounded-xl ${isLoser ? 'bg-red-500/30 border border-red-500/50' : 'bg-white/5'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-2 md:gap-3">
                        <div class="w-3 h-3 md:w-4 md:h-4 rounded-full" style="background-color: ${s.color}"></div>
                        <span class="font-bold text-base md:text-lg">${s.name}</span>
                        ${isLoser ? '<span class="text-red-400 text-xl md:text-2xl">ğŸ‘‘</span>' : ''}
                    </div>
                    <span class="text-2xl md:text-3xl font-black ${isLoser ? 'text-red-400' : 'text-white'}">${s.score}</span>
                `;
                summaryContent.appendChild(div);
            });
            
            if (minPlayers.length === scores.length) {
                situationDetails.innerHTML = `
                    <div class="text-yellow-400 font-bold text-lg md:text-xl mb-2">ğŸ² å…¨åœºç‚¹æ•°ç›¸åŒï¼</div>
                    <div class="text-gray-300 text-sm md:text-base">æ‰€æœ‰ç©å®¶æ·å‡ºäº†ç›¸åŒçš„ç‚¹æ•° <span class="text-white font-bold">${minScore}</span> ç‚¹</div>
                    <div class="text-gray-400 mt-2 text-sm md:text-base">éœ€è¦é‡æ–°å¼€å§‹æœ¬è½®æ¸¸æˆ</div>
                `;
                losers = [];
                restartBtn.classList.remove('hidden');
                restartBtn.onclick = restartRound;
                document.querySelector('button[onclick="confirmPunishment()"]').classList.add('hidden');
                
            } else if (minPlayers.length === 1) {
                losers = [minPlayers[0].id];
                situationDetails.innerHTML = `
                    <div class="text-red-400 font-bold text-lg md:text-xl mb-2">ğŸ¯ ç¡®å®šå—ç½šè€…</div>
                    <div class="text-gray-300 text-sm md:text-base">
                        <span style="color: ${minPlayers[0].color}" class="font-bold text-lg md:text-xl">${minPlayers[0].name}</span> 
                        æ·å‡ºäº†æœ€å°ç‚¹æ•° <span class="text-white font-bold">${minScore}</span> ç‚¹
                    </div>
                    <div class="text-gray-400 mt-2 text-sm md:text-base">è¯¥ç©å®¶å°†æ¥å—çœŸå¿ƒè¯æˆ–å¤§å†’é™©æƒ©ç½š</div>
                `;
                restartBtn.classList.add('hidden');
                document.querySelector('button[onclick="confirmPunishment()"]').classList.remove('hidden');
                
            } else {
                losers = minPlayers.map(p => p.id);
                situationDetails.innerHTML = `
                    <div class="text-orange-400 font-bold text-lg md:text-xl mb-2">âš”ï¸ è¿›å…¥å¯¹å†³ï¼</div>
                    <div class="text-gray-300 text-sm md:text-base mb-2">ä»¥ä¸‹ç©å®¶ç‚¹æ•°ç›¸åŒä¸”æœ€å°ï¼š</div>
                    <div class="flex flex-wrap gap-2 mb-2">
                        ${minPlayers.map(p => `
                            <span class="px-2 py-1 md:px-3 md:py-1 rounded-full text-white font-bold text-xs md:text-sm" style="background-color: ${p.color}">${p.name}</span>
                        `).join('')}
                    </div>
                    <div class="text-gray-400 text-sm md:text-base">è¿™äº›ç©å®¶éœ€è¦é‡æ–°æŠ•æ·ï¼Œç‚¹æ•°å°è€…å—ç½š</div>
                `;
                restartBtn.classList.add('hidden');
                document.querySelector('button[onclick="confirmPunishment()"]').classList.remove('hidden');
            }
            
            document.getElementById('summaryModal').classList.remove('hidden');
        }

        function confirmPunishment() {
            document.getElementById('summaryModal').classList.add('hidden');
            
            if (losers.length === 0) {
                return;
            }
            
            if (isTiebreak && losers.length > 1) {
                currentScores = {};
                hasRolled.clear();
                
                document.querySelectorAll('.sector').forEach((sector, i) => {
                    if (losers.includes(i)) {
                        sector.classList.remove('rolled');
                        document.getElementById(`score-${i}`).textContent = '-';
                        document.getElementById(`status-${i}`).setAttribute('opacity', '0');
                    }
                });
                
                addLog('--- å¯¹å†³å¼€å§‹ ---');
                updateRoundStatus();
                updateDiceHint();
                
                isRolling = false;
                selectPlayer(losers[0]);
            } else {
                const loserNames = losers.map(id => players[id].name).join('ã€');
                document.getElementById('punishmentTitle').textContent = `${loserNames} æ¥å—æƒ©ç½šï¼`;
                document.getElementById('choiceModal').classList.remove('hidden');
            }
        }

        function restartRound() {
            document.getElementById('summaryModal').classList.add('hidden');
            
            currentScores = {};
            hasRolled.clear();
            losers = [];
            isTiebreak = false;
            
            document.querySelectorAll('.sector').forEach(sector => {
                sector.classList.remove('rolled', 'selected');
            });
            
            players.forEach((_, i) => {
                document.getElementById(`score-${i}`).textContent = '-';
                document.getElementById(`status-${i}`).setAttribute('opacity', '0');
            });
            
            isRolling = false;
            selectedPlayer = null;
            
            addLog('--- é‡æ–°å¼€å§‹æœ¬è½® ---');
            updateRoundStatus();
            updateDiceHint();
            updateScoreBoard();
            updateMobileScoreBoard();
        }

        function selectPunishmentType(type) {
            currentPunishmentType = type;
            document.getElementById('choiceModal').classList.add('hidden');
            showCards();
        }

        function showCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            
            const usedSet = currentPunishmentType === 'truth' ? usedTruthCards : usedDareCards;
            const cardPool = currentPunishmentType === 'truth' ? truthCards : dareCards;
            const typeName = currentPunishmentType === 'truth' ? 'çœŸå¿ƒè¯' : 'å¤§å†’é™©';
            
            document.getElementById('cardsTitle').textContent = `é€‰æ‹©${typeName}å¡ç‰Œ`;
            
            const availableIndices = [];
            for (let i = 0; i < cardPool.length * 25; i++) {
                if (!usedSet.has(i)) {
                    availableIndices.push(i);
                    if (availableIndices.length >= 20) break;
                }
            }
            
            if (availableIndices.length < 20) {
                usedSet.clear();
                for (let i = 0; i < 20; i++) {
                    availableIndices.push(i);
                }
            }
            
            const shuffled = availableIndices.sort(() => Math.random() - 0.5).slice(0, 20);
            
            shuffled.forEach((cardIndex, i) => {
                const card = document.createElement('div');
                card.className = 'card w-24 h-36 md:w-32 md:h-48 relative cursor-pointer';
                card.onclick = () => selectCard(card, cardIndex, cardPool[cardIndex % cardPool.length]);
                
                card.innerHTML = `
                    <div class="card-back flex flex-col items-center justify-center border-2 border-white/50">
                        <div class="text-3xl md:text-4xl mb-2">${currentPunishmentType === 'truth' ? 'ğŸ’­' : 'ğŸ”¥'}</div>
                        <p class="text-xs font-bold">${typeName}</p>
                        <p class="text-xs mt-1 text-white/70">#${(cardIndex % 500) + 1}</p>
                    </div>
                    <div class="card-front flex flex-col items-center justify-center border-2 border-white/50 bg-white text-gray-800 p-2 md:p-3">
                        <p class="text-xs md:text-sm leading-relaxed font-medium">${cardPool[cardIndex % cardPool.length]}</p>
                    </div>
                `;
                
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, i * 50);
                
                container.appendChild(card);
            });
            
            document.getElementById('cardsModal').classList.remove('hidden');
        }

        function selectCard(cardElement, cardIndex, content) {
            const usedSet = currentPunishmentType === 'truth' ? usedTruthCards : usedDareCards;
            usedSet.add(cardIndex);
            
            document.getElementById('cardsModal').classList.add('hidden');
            
            const resultCard = document.getElementById('resultCard');
            const resultContent = document.getElementById('resultContent');
            
            resultCard.classList.remove('enlarged', 'flipped');
            resultContent.innerHTML = `
                <div class="text-3xl md:text-4xl mb-4">${currentPunishmentType === 'truth' ? 'ğŸ’­' : 'ğŸ”¥'}</div>
                <p class="text-lg md:text-xl font-bold mb-2">${currentPunishmentType === 'truth' ? 'çœŸå¿ƒè¯' : 'å¤§å†’é™©'}</p>
                <p class="text-sm md:text-lg">${content}</p>
            `;
            
            document.getElementById('resultModal').classList.remove('hidden');
            
            setTimeout(() => {
                resultCard.classList.add('flipped');
            }, 500);
            
            setTimeout(() => {
                resultCard.classList.add('enlarged');
            }, 1200);
        }

        function closeCardsModal() {
            document.getElementById('cardsModal').classList.add('hidden');
        }

        function nextRound() {
            document.getElementById('resultModal').classList.add('hidden');
            document.getElementById('resultCard').classList.remove('flipped', 'enlarged');
            
            currentScores = {};
            hasRolled.clear();
            losers = [];
            isTiebreak = false;
            currentRound++;
            
            document.querySelectorAll('.sector').forEach(sector => {
                sector.classList.remove('rolled', 'selected');
            });
            
            players.forEach((_, i) => {
                document.getElementById(`score-${i}`).textContent = '-';
                document.getElementById(`status-${i}`).setAttribute('opacity', '0');
            });
            
            isRolling = false;
            selectedPlayer = null;
            
            addLog(`--- ç¬¬ ${currentRound + 1} è½®å¼€å§‹ ---`);
            updateRoundStatus();
            updateDiceHint();
            updateScoreBoard();
            updateMobileScoreBoard();
        }

        function updateScoreBoard() {
            const board = document.getElementById('scoreBoard');
            if (!board) return;
            
            board.innerHTML = players.map(p => {
                const hasScore = currentScores[p.id] !== undefined;
                return `
                    <div class="flex items-center justify-between p-2 rounded-lg ${hasScore ? 'bg-white/10' : ''}">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${p.color}"></div>
                            <span class="${hasScore ? 'text-white' : 'text-gray-400'} text-sm">${p.name}</span>
                            ${hasRolled.has(p.id) ? '<span class="text-green-400 text-xs">âœ“</span>' : ''}
                        </div>
                        <span class="font-bold ${hasScore ? 'text-cyan-400' : 'text-gray-600'}" id="board-score-${p.id}">
                            ${hasScore ? currentScores[p.id] : '-'}
                        </span>
                    </div>
                `;
            }).join('');
        }

        function updateMobileScoreBoard() {
            const board = document.getElementById('mobileScoreBoard');
            if (!board) return;
            
            board.innerHTML = players.map(p => {
                const hasScore = currentScores[p.id] !== undefined;
                return `
                    <div class="flex items-center justify-between p-2 rounded-lg ${hasScore ? 'bg-white/10' : 'bg-white/5'}">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background-color: ${p.color}"></div>
                            <span class="${hasScore ? 'text-white' : 'text-gray-400'} text-sm">${p.name}</span>
                            ${hasRolled.has(p.id) ? '<span class="text-green-400 text-xs">âœ“</span>' : ''}
                        </div>
                        <span class="font-bold ${hasScore ? 'text-cyan-400' : 'text-gray-600'}">
                            ${hasScore ? currentScores[p.id] : '-'}
                        </span>
                    </div>
                `;
            }).join('');
            
            const mobileStatus = document.getElementById('mobileRoundStatus');
            if (mobileStatus) {
                const remaining = players.length - hasRolled.size;
                if (isTiebreak) {
                    const tieRemaining = losers.filter(id => !hasRolled.has(id)).length;
                    mobileStatus.innerHTML = `<span class="text-yellow-400">âš”ï¸ å¯¹å†³æ¨¡å¼</span> | å‰©ä½™: ${tieRemaining}/${losers.length}`;
                } else {
                    mobileStatus.innerHTML = `<span class="text-cyan-400">ğŸ² ç¬¬ ${currentRound + 1} è½®</span> | å‰©ä½™: ${remaining}/${players.length}`;
                }
            }
        }

        function toggleMobilePanel(type) {
            const panel = document.getElementById('mobilePanel');
            const scoresView = document.getElementById('mobileScoresView');
            const logsView = document.getElementById('mobileLogsView');
            
            if (type === currentMobilePanel) {
                panel.classList.remove('expanded');
                currentMobilePanel = null;
            } else {
                panel.classList.add('expanded');
                currentMobilePanel = type;
                
                if (type === 'scores') {
                    scoresView.classList.remove('hidden');
                    logsView.classList.add('hidden');
                } else if (type === 'logs') {
                    scoresView.classList.add('hidden');
                    logsView.classList.remove('hidden');
                }
            }
        }

        function addLog(message) {
            const log = document.getElementById('gameLog');
            const mobileLog = document.getElementById('mobileGameLog');
            const time = new Date().toLocaleTimeString();
            const entryHTML = `<div class="border-l-2 border-cyan-500 pl-2 text-xs md:text-sm">${message}</div>`;
            
            if (log) {
                const entry = document.createElement('div');
                entry.innerHTML = entryHTML;
                entry.className = 'animate-pulse';
                setTimeout(() => entry.classList.remove('animate-pulse'), 1000);
                log.insertBefore(entry, log.firstChild);
            }
            
            if (mobileLog) {
                const entry = document.createElement('div');
                entry.innerHTML = entryHTML;
                mobileLog.insertBefore(entry, mobileLog.firstChild);
            }
            
            // Update log badge
            const logBadge = document.getElementById('logBadge');
            if (logBadge && currentMobilePanel !== 'logs') {
                const currentCount = parseInt(logBadge.textContent) || 0;
                logBadge.textContent = currentCount + 1;
                logBadge.classList.remove('hidden');
            }
        }

        function resetGame() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                location.reload();
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (players.length > 0) {
                drawBoard();
            }
        });

        // Initialize
        initSetup();
    </script>
</body>
</html>
